{% extends 'base.html' %} {% block title %}Productos{% endblock %} {% block
content %}
<h1>Productos Disponibles:</h1>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='CSS/productos.css') }}"
/>
<form method="GET" action="{{ url_for('productos') }}" class="mb-3">
  <input
    type="text"
    name="nombre"
    placeholder="Buscar por nombre"
    class="form-control"
    value="{{ request.args.get('nombre', '') }}"
  />
  <button type="submit" class="btnproduct">Buscar</button>
</form>

<div class="tablaproductos">
  <div class="filtros-container">
    <!-- Filtro por stock -->
    <a
      href="{{ url_for('productos', filtro='stock', valor=15) }}"
      class="btn btn-sm btn-outline-warning"
      title="Productos con stock menor a 5"
    >
      Stock bajo
    </a>
    <a
      href="{{ url_for('productos', filtro='fecha_agregado') }}"
      class="btn btn-sm btn-outline-info"
      title="Ordenar por fecha agregado (más recientes)"
    >
      Recientes
    </a>

    <a
      href="{{ url_for('productos', filtro='fecha_proxima') }}"
      class="btn btn-sm btn-outline-warning"
      title="Ordenar por fecha de caducidad más próxima"
    >
      Próximos a caducar
    </a>
    <!-- Filtro por precio -->
    <a
      href="{{ url_for('productos', filtro='caros', valor=7) }}"
      class="btn btn-sm btn-outline-danger"
      title="Top 5 productos más caros"
    >
      Más caros
    </a>
    <!-- Dropdown para Proveedores -->
    <div class="dropdown d-inline-block">
      <button
        class="btn btn-sm btn-outline-primary dropdown-toggle"
        type="button"
        id="dropdownProveedores"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        Proveedores
      </button>
      <ul class="dropdown-menu" aria-labelledby="dropdownProveedores">
        {% if proveedores %} {% for prov in proveedores %}
        <li>
          <a
            class="dropdown-item"
            href="{{ url_for('productos', filtro='proveedor', valor=prov[0]) }}"
          >
            {{ prov[1] }}
          </a>
        </li>
        {% endfor %} {% else %}
        <li>
          <span class="dropdown-item text-muted">No hay proveedores</span>
        </li>
        {% endif %}
      </ul>
    </div>

    <!-- Dropdown para Categorías -->
    <div class="dropdown d-inline-block">
      <button
        class="btn btn-sm btn-outline-success dropdown-toggle"
        type="button"
        id="dropdownCategorias"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        Categorías
      </button>
      <ul class="dropdown-menu" aria-labelledby="dropdownCategorias">
        {% if categorias %} {% for cat in categorias %}
        <li>
          <a
            class="dropdown-item"
            href="{{ url_for('productos', filtro='categoria', valor=cat[0]) }}"
          >
            {{ cat[1] }}
          </a>
        </li>
        {% endfor %} {% else %}
        <li><span class="dropdown-item text-muted">No hay categorías</span></li>
        {% endif %}
      </ul>
    </div>

    <table
      class="table table-hover table-bordered table-striped align-middle text-center shadow-sm rounded"
    >
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Descripcion</th>
        <th>Precio (MX)</th>
        <th>Stock</th>
        <th>Fecha de Caducidad</th>
        <th>Categoria</th>
        <th>Proveedor</th>
        <th>Acciones</th>
        <!-- Nueva columna -->
      </tr>
      {% for producto in productos %}
      <tr>
        <td>{{ producto[0] }}</td>
        <td>{{ producto[1] }}</td>
        <td>{{ producto[2] }}</td>
        <td>{{ producto[3] }}</td>
        <td>{{ producto[4] }}</td>
        <td>{{ producto[5] }}</td>
        <td>{{ producto[6] }}</td>
        <td>{{ producto[7] }}</td>
        <td>
          <!-- Botón para eliminar producto -->
          <button
            class="btn btn-sm btn-danger eliminar-producto"
            data-id="{{ producto[0] }}"
            data-nombre="{{ producto[1] }}"
          >
            <i class="bi bi-trash"></i> Eliminar
          </button>
        </td>
      </tr>
      {% endfor %}
    </table>

    <!-- Modal de confirmación para eliminar -->
    <div
      class="modal fade"
      id="confirmarEliminarModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar Eliminación</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              ¿Está seguro de eliminar el producto
              <strong id="nombreProductoEliminar"></strong>?
            </p>
            <p class="text-danger">Esta acción no se puede deshacer.</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="btnConfirmarEliminar"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal para agregar producto -->
  <div
    class="modal fade"
    id="agregarProductoModal"
    tabindex="-1"
    aria-labelledby="agregarProductoModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="agregarProductoModalLabel">
            Agregar Nuevo Producto
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form
            id="formAgregarProducto"
            action="{{ url_for('agregar_producto') }}"
            method="POST"
          >
            <div class="mb-3">
              <label for="nombre" class="form-label">Nombre</label>
              <input
                type="text"
                class="form-control"
                id="nombre"
                name="nombre"
                required
              />
            </div>
            <div class="mb-3">
              <label for="descripcion" class="form-label">Descripción</label>
              <textarea
                class="form-control"
                id="descripcion"
                name="descripcion"
                rows="3"
              ></textarea>
            </div>
            <div class="mb-3">
              <label for="precio" class="form-label"
                >Precio por Unidad o Kg</label
              >
              <input
                type="number"
                step="0.01"
                class="form-control"
                id="precio"
                name="precio"
                required
              />
            </div>
            <div class="mb-3">
              <label for="stock" class="form-label">Stock</label>
              <input
                type="number"
                class="form-control"
                id="stock"
                name="stock"
                required
              />
            </div>
            <div class="mb-3">
              <label for="fecha_caducidad" class="form-label"
                >Fecha de Caducidad</label
              >
              <input
                type="date"
                class="form-control"
                id="fecha_caducidad"
                name="fecha_caducidad"
              />
            </div>

            <div class="form-check mb-3">
              <input
                class="form-check-input"
                type="checkbox"
                id="no_caduca"
                name="no_caduca"
              />
              <label class="form-check-label" for="no_caduca"
                >No tiene fecha de caducidad</label
              >
            </div>
            <div class="mb-3">
              <label for="categoria" class="form-label">Categoría</label>
              <select
                class="form-select"
                id="categoria"
                name="categoria"
                required
              >
                {% for cat in categorias %}
                <option value="{{ cat[0] }}">{{ cat[1] }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="proveedor" class="form-label">Proveedor</label>
              <select
                class="form-select"
                id="proveedor"
                name="proveedor"
                required
              >
                {% for prov in proveedores %}
                <option value="{{ prov[0] }}">{{ prov[1] }}</option>
                {% endfor %}
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button
            type="submit"
            form="formAgregarProducto"
            class="btn btn-primary"
          >
            Guardar Producto
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modifica el card para abrir el modal -->
  <div class="cards">
    <div
      class="agregarproducto"
      data-bs-toggle="modal"
      data-bs-target="#agregarProductoModal"
      style="cursor: pointer"
    >
      <h3>Agregar Nuevo Producto</h3>
    </div>

  </div>
  {% endblock %}
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    let productoAEliminar = null;
    
    // Mostrar modal de confirmación al hacer clic en eliminar
    $('.eliminar-producto').click(function() {
        productoAEliminar = {
            id: $(this).data('id'),
            nombre: $(this).data('nombre')
        };
        $('#nombreProductoEliminar').text(productoAEliminar.nombre);
        $('#confirmarEliminarModal').modal('show');
    });
    
    // Confirmar eliminación
    $('#btnConfirmarEliminar').click(function() {
        if (productoAEliminar) {
            $.ajax({
                url: "{{ url_for('eliminar_producto') }}",
                method: 'POST',
                data: { id: productoAEliminar.id },
                success: function(response) {
                    if (response.success) {
                        location.reload(); // Recargar la página para ver los cambios
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function() {
                    alert('Error al comunicarse con el servidor');
                }
            });
        }
        $('#confirmarEliminarModal').modal('hide');
    });
});
</script>
{% endblock %}